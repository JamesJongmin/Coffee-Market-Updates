<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Market Updates Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.7;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            font-weight: 300;
            margin-bottom: 15px;
        }
        
        .description {
            font-size: 1.1em;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* 차트 대시보드 스타일 */
        .dashboard-section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 2em;
            font-weight: 700;
            color: #8B4513;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8B4513;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .chart-source {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            font-size: 1.1em;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #8B4513;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.95em;
            color: #666;
            font-weight: 500;
        }
        
        .search-filter {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #8B4513;
            outline: none;
        }
        
        .filter-select {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #8B4513;
            cursor: pointer;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .report-date {
            font-size: 0.9em;
            color: #8B4513;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .report-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .report-summary {
            font-size: 0.95em;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .report-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tag {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .read-more {
            display: inline-flex;
            align-items: center;
            color: #8B4513;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.95em;
            transition: color 0.3s ease;
        }
        
        .read-more:hover {
            color: #A0522D;
        }
        
        .read-more::after {
            content: " →";
            margin-left: 5px;
            transition: margin-left 0.3s ease;
        }
        
        .read-more:hover::after {
            margin-left: 10px;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1em;
        }
        
        footer {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            margin-top: 40px;
            background: white;
            border-radius: 15px;
        }
        
        .footer-links {
            margin-top: 15px;
        }
        
        .footer-links a {
            color: #8B4513;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        /* 로딩 상태 표시 */
        .reports-loading {
            text-align: center;
            padding: 40px;
            color: #8B4513;
            font-size: 1.1em;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Coffee Market Updates</h1>
            <p class="subtitle">Coffee Futures Market Analysis & Dashboard</p>
            <p class="description">
                커피 선물 시장 분석 보고서 아카이브 및 실시간 시장 대시보드입니다. <br/>
                주간 시장 동향, 가격 변동 및 글로벌 수급 현황을 정기적으로 업데이트합니다.
            </p>
        </header>

        <!-- 차트 대시보드 섹션 -->
        <div class="dashboard-section">
            <h2 class="section-title">📊 Market Dashboard</h2>
            <div class="charts-grid">
                <!-- Coffee Futures Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Coffee Futures</div>
                        <div class="chart-source">출처: ICE</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-coffee">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="coffeeChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- USD/BRL Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">미국달러-브라질헤알 환율</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-usd">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="usdChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- CFTC Positions Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">CFTC 투기 포지션 (순매수)</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-cftc">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="cftcChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- ICO Composite Index Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">ICO Composite Index</div>
                        <div class="chart-source">출처: ICO</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-ico">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="icoChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-number" id="totalReports">-</div>
                <div class="stat-label">총 보고서 수</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="latestDate">-</div>
                <div class="stat-label">최신 업데이트</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">주간</div>
                <div class="stat-label">업데이트 주기</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">KR/EN</div>
                <div class="stat-label">언어 지원</div>
            </div>
        </div>

        <div class="search-filter">
            <div class="filter-row">
                <input type="text" class="search-input" id="searchInput" placeholder="보고서 제목이나 내용으로 검색하세요...">
                <select class="filter-select" id="yearFilter">
                    <option value="">전체 년도</option>
                </select>
                <select class="filter-select" id="monthFilter">
                    <option value="">전체 월</option>
                </select>
            </div>
        </div>

        <div class="reports-loading" id="reportsLoading">
            <div class="spinner" style="margin: 0 auto 15px;"></div>
            보고서 목록을 불러오는 중...
        </div>

        <div class="reports-grid" id="reportsGrid" style="display: none;">
            <!-- 보고서 카드들이 여기에 동적으로 추가됩니다 -->
        </div>

        <div class="no-results" id="noResults" style="display: none;">
            <h3>검색 결과가 없습니다</h3>
            <p>다른 검색어나 필터를 시도해보세요.</p>
        </div>

        <footer>
            <p><strong>Published by Align Commodities & Yellowknife </strong></p>
            <p>전문적인 커피 시장 분석과 Market Intelligence를 제공합니다.</p>
            <div class="footer-links">
                <a href="mailto:james.baek@aligncommodities.com">Contact</a>
                <a href="https://github.com/jamesjongmin/Coffee-Market-Updates">GitHub</a>
                <a href="#latest">Latest Report</a>
            </div>
            <p style="margin-top: 15px; font-size: 0.8em; opacity: 0.7;">
                본 리포트는 정보 제공 목적으로 작성되었으며, 투자 권유가 아닙니다.
            </p>
        </footer>
    </div>

<script>
        let allReports = [];
        let charts = {};

        // Excel 파일 읽기 함수
        async function readExcelFile(filename) {
            try {
                console.log(`Excel 파일 로딩 시도: ${filename}`);
                
                // 타임아웃 설정 (15초)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(filename, {
                    signal: controller.signal,
                    cache: 'no-cache', // 캐시 무시
                    headers: {
                        'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error(`파일 로딩 실패: ${filename}, 상태: ${response.status}`);
                    throw new Error(`Failed to fetch ${filename} - Status: ${response.status}`);
                }
                
                console.log(`${filename} 성공적으로 로드됨, 크기: ${response.headers.get('content-length')} bytes`);
                
                const arrayBuffer = await response.arrayBuffer();
                console.log(`${filename} ArrayBuffer 크기: ${arrayBuffer.byteLength} bytes`);
                
                if (arrayBuffer.byteLength === 0) {
                    throw new Error(`${filename} 파일이 비어있습니다`);
                }
                
                const workbook = XLSX.read(arrayBuffer, {
                    type: 'array',
                    cellDates: true,
                    cellNF: false,
                    cellText: false
                });
                
                console.log(`${filename} 워크북 시트 목록:`, workbook.SheetNames);
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const data = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: null,
                    raw: false
                });
                
                console.log(`${filename} 원본 데이터 행 수:`, data.length);
                console.log(`${filename} 첫 3행:`, data.slice(0, 3));
                
                // 첫 번째 행은 헤더, 두 번째 행은 "Close" 등의 추가 헤더이므로 3번째 행부터 데이터
                const dataRows = data.slice(2);
                
                const processedData = dataRows.map((row, index) => {
                    const dateValue = row[0];
                    const priceValue = row[1];
                    
                    if (!dateValue || priceValue === null || priceValue === undefined || priceValue === '') {
                        return null;
                    }
                    
                    return {
                        date: dateValue,
                        value: priceValue
                    };
                }).filter(row => row !== null);
                
                console.log(`${filename} 처리된 데이터 포인트:`, processedData.length);
                console.log(`${filename} 처리된 첫 3개 데이터:`, processedData.slice(0, 3));
                console.log(`${filename} 처리된 마지막 3개 데이터:`, processedData.slice(-3));
                
                if (processedData.length === 0) {
                    throw new Error(`${filename}에서 유효한 데이터를 찾을 수 없습니다`);
                }
                
                // 날짜순으로 정렬 (오래된 것 → 최신 순서로)
                processedData.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                
                return processedData;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error(`${filename} 로딩 타임아웃 (15초 초과)`);
                    throw new Error(`${filename} 로딩 타임아웃`);
                }
                console.error(`Error reading ${filename}:`, error);
                throw error;
            }
        }

        // 날짜 변환 함수
        function parseDate(dateValue) {
            if (typeof dateValue === 'number') {
                // Excel 날짜 시리얼 번호인 경우
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return date;
            } else if (typeof dateValue === 'string') {
                return new Date(dateValue);
            }
            return new Date(dateValue);
        }

        // 차트 생성 함수들 (기존 코드 유지)
        async function createCoffeeChart() {
            const data = await readExcelFile('coffeefutures.xlsx');
            const loadingElement = document.getElementById('loading-coffee');
            const chartElement = document.getElementById('coffeeChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            // 날짜 라벨 생성 (3-6개월 간격)
            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6)); // 약 6개 구간
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.ico = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ICO Composite Index',
                        data: chartData,
                        borderColor: '#9B59B6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'I-CIP (cents/lb)'
                            }
                        }
                    }
                }
            });
        }

        // 동적으로 Reports 폴더를 스캔하고 메타데이터를 추출하는 함수
        async function scanReportsFolder() {
            console.log('동적 보고서 스캔 시작...');
            const reports = [];
            
            // 스캔할 폴더 패턴들 (최근 6개월)
            const now = new Date();
            const patterns = [];
            
            for (let monthOffset = 0; monthOffset < 6; monthOffset++) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - monthOffset, 1);
                const year = targetDate.getFullYear();
                const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                patterns.push(`Reports/${year}/${month}/`);
            }
            
            for (const pattern of patterns) {
                try {
                    const files = await scanFolderForHTMLFiles(pattern);
                    console.log(`${pattern}에서 ${files.length}개 파일 발견`);
                    
                    for (const file of files) {
                        const metadata = await extractHTMLMetadata(file);
                        if (metadata) {
                            reports.push(metadata);
                            console.log(`메타데이터 추출 완료: ${metadata.title}`);
                        }
                    }
                } catch (error) {
                    console.warn(`${pattern} 스캔 실패:`, error);
                }
            }
            
            return reports.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // HTML 파일에서 메타데이터 추출
        async function extractHTMLMetadata(filePath) {
            try {
                console.log(`메타데이터 추출 중: ${filePath}`);
                const response = await fetch(filePath);
                if (!response.ok) return null;
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 제목 추출 (우선순위: h1 > title)
                let title = doc.querySelector('h1')?.textContent?.trim();
                if (!title) {
                    title = doc.querySelector('title')?.textContent?.trim();
                }
                if (!title || title.includes('Coffee Market Updates')) {
                    title = '커피 선물 시장 분석';
                }
                
                // 부제목 추출
                let subtitle = doc.querySelector('.subtitle')?.textContent?.trim();
                if (!subtitle) {
                    subtitle = doc.querySelector('h2')?.textContent?.trim() || '';
                }
                
                // 요약 추출 (Executive Summary에서)
                let summary = '';
                const executiveSummary = doc.querySelector('.executive-summary p');
                if (executiveSummary) {
                    summary = executiveSummary.textContent.trim();
                    // HTML 태그나 특수문자 제거
                    summary = summary.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ');
                } else {
                    // 대체: 첫 번째 문단
                    const firstP = doc.querySelector('p');
                    if (firstP) {
                        summary = firstP.textContent.trim();
                        summary = summary.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ');
                    }
                }
                
                // 요약 길이 제한
                if (summary.length > 200) {
                    summary = summary.substring(0, 200) + '...';
                }
                
                if (!summary) {
                    summary = '커피 선물 시장의 최신 동향과 분석을 제공합니다.';
                }
                
                // 스마트 태그 추출 시스템
                const tags = await extractSmartTags(doc, filePath);
                
                // 파일명에서 날짜 추출
                const fileNameMatch = filePath.match(/(\d{4})-(\d{2})-(\d{2})\.html/);
                if (!fileNameMatch) return null;
                
                const [, year, month, day] = fileNameMatch;
                const date = `${year}-${month}-${day}`;
                const displayDate = `${year}년 ${parseInt(month)}월 ${parseInt(day)}일`;
                
                return {
                    date,
                    displayDate,
                    title,
                    subtitle,
                    summary,
                    tags: [...new Set(tags)].slice(0, 8), // 중복 제거 및 최대 8개
                    link: filePath,
                    year,
                    month: month.padStart(2, '0')
                };
                
            } catch (error) {
                console.error(`메타데이터 추출 실패 ${filePath}:`, error);
                return null;
            }
        }

        // 스마트 태그 추출 시스템
        async function extractSmartTags(doc, filePath) {
            const tags = new Set();
            
            // 1. 기존 태그 우선 추출
            const existingTags = doc.querySelectorAll('.tag, .tags span');
            existingTags.forEach(el => {
                const tagText = el.textContent.trim();
                if (tagText && tagText.length < 20 && tagText.length > 1) {
                    tags.add(tagText);
                }
            });
            
            // 2. 기존 태그가 충분하면 그대로 사용
            if (tags.size >= 5) {
                return Array.from(tags);
            }
            
            // 3. 컨텐츠 기반 스마트 태그 생성
            const bodyText = doc.body.textContent.toLowerCase();
            const titleText = (doc.querySelector('h1')?.textContent || '').toLowerCase();
            const summaryText = (doc.querySelector('.executive-summary p, .main-story p')?.textContent || '').toLowerCase();
            
            // 핵심 키워드 사전 (카테고리별)
            const keywordCategories = {
                '아라비카': ['아라비카', 'arabica', 'kcn25', 'kcn', '7월물'],
                '로부스타': ['로부스타', 'robusta', 'rmn25', 'rmn', '런던'],
                '브라질': ['브라질', 'brazil', '브라질리언', '미나스', '세하도', '헤알'],
                '베트남': ['베트남', 'vietnam', '베트남산', '중부고원', '달랏'],
                '생산량': ['생산량', '수확', '작황', '생산', 'harvest', 'crop'],
                '가격분석': ['가격', '센트', '상승', '하락', '변동성', '급등', '급락'],
                '수출입': ['수출', '수입', '무역', 'export', 'import', '수출량'],
                '재고': ['재고', 'inventory', 'stock', 'ice재고', '인증재고'],
                '기술적분석': ['기술적', '지지선', '저항선', '차트', '패턴', 'stochastic'],
                '기상': ['기상', '날씨', '강우', '가뭄', '서리', '엘니뇨', '라니냐'],
                '투기': ['투기', 'cftc', '포지션', '헤지펀드', '매수', '매도'],
                '시장동향': ['시장', '동향', '전망', '분석', '업계', '트렌드'],
                '기업': ['스타벅스', '네슬레', 'jde', 'peet', 'nestlé', 'sbux'],
                '정책': ['정부', '정책', '관세', '보조금', '규제', 'usda'],
                '지지저항': ['지지선', '저항선', '돌파', '이탈', '테스트'],
                '공급수요': ['공급', '수요', '적자', '흑자', '부족', '과잉'],
                '선물거래': ['선물', 'futures', 'ice', '거래량', '미결제약정']
            };
            
            // 키워드 빈도 및 중요도 계산
            const keywordScores = {};
            
            Object.entries(keywordCategories).forEach(([category, keywords]) => {
                let score = 0;
                keywords.forEach(keyword => {
                    // 제목에서 발견시 가중치 3배
                    if (titleText.includes(keyword)) score += 3;
                    // 요약에서 발견시 가중치 2배  
                    if (summaryText.includes(keyword)) score += 2;
                    // 본문에서 발견시 기본 점수
                    const bodyMatches = (bodyText.match(new RegExp(keyword, 'g')) || []).length;
                    score += bodyMatches * 0.5;
                });
                
                if (score > 0) {
                    keywordScores[category] = score;
                }
            });
            
            // 파일명 기반 추가 태그
            if (filePath.includes('2025-06-13')) {
                keywordScores['전망분석'] = (keywordScores['전망분석'] || 0) + 2;
                keywordScores['심층분석'] = (keywordScores['심층분석'] || 0) + 2;
            }
            
            // 특별 패턴 감지
            if (bodyText.includes('executive summary') || bodyText.includes('핵심 요약')) {
                keywordScores['종합분석'] = (keywordScores['종합분석'] || 0) + 1;
            }
            
            if (bodyText.includes('주간') || bodyText.includes('weekly')) {
                keywordScores['주간동향'] = (keywordScores['주간동향'] || 0) + 2;
            }
            
            if (bodyText.includes('단기') || bodyText.includes('short-term')) {
                keywordScores['단기전망'] = (keywordScores['단기전망'] || 0) + 2;
            }
            
            // 수치/통계 언급시
            if (bodyText.match(/\d+%|\d+센트|\d+포인트/)) {
                keywordScores['수치분석'] = (keywordScores['수치분석'] || 0) + 1;
            }
            
            // 점수 기준 상위 태그 선택
            const sortedTags = Object.entries(keywordScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8)
                .map(([tag,]) => tag);
            
            // 기존 태그와 새 태그 합치기
            sortedTags.forEach(tag => tags.add(tag));
            
            // 최소 태그 보장
            if (tags.size < 3) {
                tags.add('커피선물');
                tags.add('시장분석'); 
                tags.add('글로벌동향');
            }
            
            console.log(`${filePath} 태그 추출 완료:`, Array.from(tags));
            return Array.from(tags);
        }

        // 폴더에서 HTML 파일 목록 가져오기
        async function scanFolderForHTMLFiles(folderPath) {
            const files = [];
            
            // 날짜 패턴으로 파일 존재 여부 확인 (1일부터 31일까지)
            for (let day = 1; day <= 31; day++) {
                const dayStr = String(day).padStart(2, '0');
                
                // 폴더 경로에서 연도/월 추출
                const pathMatch = folderPath.match(/Reports\/(\d{4})\/(\d{2})\//);
                if (!pathMatch) continue;
                
                const [, year, month] = pathMatch;
                const fileName = `${year}-${month}-${dayStr}.html`;
                const fullPath = `${folderPath}${fileName}`;
                
                try {
                    const response = await fetch(fullPath, { method: 'HEAD' });
                    if (response.ok) {
                        files.push(fullPath);
                    }
                } catch (error) {
                    // 파일이 없으면 무시
                }
            }
            
            return files;
        }

        // reports.json 로드 시도, 실패시 동적 스캔
        async function loadReportsFromJSON() {
            try {
                console.log('reports.json 로딩 시도...');
                const response = await fetch('reports.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.reports && data.reports.length > 0) {
                        console.log(`reports.json에서 ${data.reports.length}개 보고서 로드됨`);
                        return data.reports;
                    }
                }
            } catch (error) {
                console.warn('reports.json 로드 실패, 동적 스캔 시작:', error);
            }
            
            // reports.json이 없거나 비어있으면 동적 스캔
            console.log('동적 보고서 폴더 스캔 시작...');
            const scannedReports = await scanReportsFolder();
            
            if (scannedReports.length === 0) {
                // 스캔 결과가 없으면 기본 데이터 반환
                console.log('스캔 결과 없음, 기본 데이터 사용');
                return [
                    {
                        date: '2025-06-13',
                        displayDate: '2025년 6월 13일',
                        title: '단기 커피 선물 가격 전망 및 방향성 점검',
                        subtitle: 'Short-term Coffee Futures Price Forecast',
                        summary: 'KCN25는 349.90센트로 +0.60% 상승하며 1차 지지선을 상회 회복했습니다. 단기적으로는 브라질 수확 진행과 투기적 숏 포지션이 하방 압력으로 작용하나, 구조적으로는 글로벌 아라비카 적자가 강세 요인으로 작용합니다.',
                        tags: ['아라비카', '로부스타', '브라질수확', '투기포지션', '기술적분석'],
                        link: 'Reports/2025/06/2025-06-13.html',
                        year: '2025',
                        month: '06'
                    }
                ];
            }
            
            console.log(`동적 스캔 완료: ${scannedReports.length}개 보고서`);
            return scannedReports;
        }

        function renderReports(filteredReports = allReports) {
            const grid = document.getElementById('reportsGrid');
            const noResults = document.getElementById('noResults');
            const loading = document.getElementById('reportsLoading');
            
            loading.style.display = 'none';
            
            if (filteredReports.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noResults.style.display = 'none';
            
            grid.innerHTML = filteredReports.map(report => `
                <div class="report-card" onclick="window.location.href='${report.link}'">
                    <div class="report-date">${report.displayDate}</div>
                    <h3 class="report-title">${report.title}</h3>
                    <p class="report-summary">${report.summary}</p>
                    <div class="report-tags">
                        ${report.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <a href="${report.link}" class="read-more">보고서 읽기</a>
                </div>
            `).join('');
        }

        function filterReports() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            const filtered = allReports.filter(report => {
                const matchesSearch = report.title.toLowerCase().includes(searchTerm) || 
                                    report.summary.toLowerCase().includes(searchTerm) ||
                                    report.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                const matchesYear = !yearFilter || report.year === yearFilter;
                const matchesMonth = !monthFilter || report.month === monthFilter;
                
                return matchesSearch && matchesYear && matchesMonth;
            });
            
            renderReports(filtered);
        }

        function updateFilters() {
            const years = [...new Set(allReports.map(r => r.year))].sort().reverse();
            const months = [...new Set(allReports.map(r => r.month))].sort();
            
            const yearSelect = document.getElementById('yearFilter');
            const monthSelect = document.getElementById('monthFilter');
            
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">전체 년도</option>';
                years.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}년</option>`;
                });
            }
            
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">전체 월</option>';
                months.forEach(month => {
                    const monthName = parseInt(month) + '월';
                    monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
                });
            }
        }

        function updateStats() {
            const totalElement = document.getElementById('totalReports');
            const latestElement = document.getElementById('latestDate');
            
            if (totalElement) {
                totalElement.textContent = allReports.length;
            }
            
            if (latestElement && allReports.length > 0) {
                latestElement.textContent = allReports[0].displayDate.substring(0, 7);
            }
        }

        // 초기화 함수
        async function init() {
            try {
                console.log('=== 초기화 시작 ===');
                
                // Chart.js 로드 확인
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js가 로드되지 않았습니다!');
                    return;
                }
                console.log('Chart.js 로드 확인됨');
                
                // XLSX 라이브러리 확인
                if (typeof XLSX === 'undefined') {
                    console.error('XLSX 라이브러리가 로드되지 않았습니다!');
                    return;
                }
                console.log('XLSX 라이브러리 로드 확인됨');

                // 차트들 순차적으로 로드 (병렬 대신 순차)
                console.log('=== 차트 로딩 시작 ===');
                await createCoffeeChart();
                await createUSDChart();
                await createCFTCChart();
                await createICOChart();
                console.log('=== 차트 로딩 완료 ===');

                // 보고서 데이터 로드 (동적 스캔 포함)
                console.log('=== 보고서 로딩 시작 ===');
                allReports = await loadReportsFromJSON();
                updateFilters();
                updateStats();
                renderReports();
                console.log('=== 보고서 로딩 완료 ===');
                
                // 이벤트 리스너 설정
                document.getElementById('searchInput').addEventListener('input', filterReports);
                document.getElementById('yearFilter').addEventListener('change', filterReports);
                document.getElementById('monthFilter').addEventListener('change', filterReports);
                
                console.log('=== 초기화 완료 ===', allReports.length, '개 보고서');
                
            } catch (error) {
                console.error('초기화 중 오류:', error);
                // 오류 발생 시 로딩 화면 숨기기
                document.getElementById('reportsLoading').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
            }
        }

        // 페이지 로드시 초기화 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료, 초기화 시작');
            init();
        });
        
        // 추가 로드 이벤트도 등록 (백업)
        window.addEventListener('load', function() {
            console.log('윈도우 로드 완료');
            // DOM 이벤트가 실행되지 않은 경우에만 실행
            if (!window.initStarted) {
                window.initStarted = true;
                init();
            }
        });
        
        // 즉시 테스트 함수 (개발자 도구에서 수동 실행용)
        window.testExcelLoad = async function() {
            console.log('=== 수동 Excel 테스트 ===');
            try {
                const data = await readExcelFile('coffeefutures.xlsx');
                console.log('테스트 결과:', data ? `${data.length}개 데이터 포인트` : '실패');
                return data;
            } catch (error) {
                console.error('테스트 실패:', error);
                return null;
            }
        };


                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.coffee = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Coffee Futures Price',
                        data: chartData,
                        borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (cents/lb)'
                            }
                        }
                    }
                }
            });
        }

        async function createUSDChart() {
            const data = await readExcelFile('usdbrl.xlsx');
            const loadingElement = document.getElementById('loading-usd');
            const chartElement = document.getElementById('usdChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6));
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.usd = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'USD/BRL Rate',
                        data: chartData,
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'BRL per USD'
                            }
                        }
                    }
                }
            });
        }

        async function createCFTCChart() {
            const data = await readExcelFile('cftcpositions.xlsx');
            const loadingElement = document.getElementById('loading-cftc');
            const chartElement = document.getElementById('cftcChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseInt(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6));
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.cftc = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Net Long Positions',
                        data: chartData,
                        backgroundColor: chartData.map(point => point.y >= 0 ? '#27AE60' : '#E74C3C'),
                        borderColor: chartData.map(point => point.y >= 0 ? '#229954' : '#C0392B'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Net Long Positions'
                            }
                        }
                    }
                }
            });
        }

        async function createICOChart() {
            const data = await readExcelFile('icoicip.xlsx');
            const loadingElement = document.getElementById('loading-ico');
            const chartElement = document.getElementById('icoChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6));
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', {

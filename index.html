<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Market Updates Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.7;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .live-indicator {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.3em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
            animation: pulse-live 2s infinite;
        }
        
        .live-indicator::before {
            content: '●';
            color: #fff;
            font-size: 1.2em;
            margin-right: 4px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes pulse-live {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .date-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.35em;
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            font-weight: 300;
            margin-bottom: 15px;
        }
        
        .description {
            font-size: 1.1em;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #8B4513;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.95em;
            color: #666;
            font-weight: 500;
        }
        
        .search-filter {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #8B4513;
            outline: none;
        }
        
        .filter-select {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #8B4513;
            cursor: pointer;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .report-date {
            font-size: 0.9em;
            color: #8B4513;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .report-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.4;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .new-badge {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-size: 0.7em;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(231, 76, 60, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
            }
        }
        
        .report-summary {
            font-size: 0.95em;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .report-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tag {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .read-more {
            display: inline-flex;
            align-items: center;
            color: #8B4513;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.95em;
            transition: color 0.3s ease;
        }
        
        .read-more:hover {
            color: #A0522D;
        }
        
        .read-more::after {
            content: " →";
            margin-left: 5px;
            transition: margin-left 0.3s ease;
        }
        
        .read-more:hover::after {
            margin-left: 10px;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1em;
        }
        
        /* 차트 대시보드 스타일 */
        .dashboard-section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 2em;
            font-weight: 700;
            color: #8B4513;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8B4513;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .chart-source {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .chart-analysis {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border-left: 4px solid #8B4513;
            font-size: 0.9em;
            line-height: 1.5;
            color: #495057;
        }
        
        .chart-analysis .analysis-title {
            font-weight: 600;
            color: #8B4513;
            margin-bottom: 6px;
            font-size: 0.95em;
        }
        
        .chart-analysis .analysis-text {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.1em;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            margin-top: 40px;
            background: white;
            border-radius: 15px;
        }
        
        .footer-links {
            margin-top: 15px;
        }
        
        .footer-links a {
            color: #8B4513;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                Coffee Market Updates
                <span class="live-indicator">Live</span>
                <span class="date-badge" id="currentDate">오늘 날짜</span>
            </h1>
            <p class="subtitle">Coffee Futures Market Analysis & Dashboard</p>
            <p class="description">
                커피 선물 시장 분석 보고서 아카이브 및 실시간 시장 대시보드입니다. <br/>
                주간 시장 동향, 가격 변동 및 글로벌 수급 현황을 정기적으로 업데이트합니다.
            </p>
        </header>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-number" id="totalReports">5</div>
                <div class="stat-label">총 보고서 수</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="latestDate">2025.06</div>
                <div class="stat-label">최신 업데이트</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">주간</div>
                <div class="stat-label">업데이트 주기</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">KR/EN</div>
                <div class="stat-label">언어 지원</div>
            </div>
        </div>

        <div class="search-filter">
            <div class="filter-row">
                <input type="text" class="search-input" id="searchInput" placeholder="보고서 제목이나 내용으로 검색하세요...">
                <select class="filter-select" id="yearFilter">
                    <option value="">전체 년도</option>
                    <option value="2025">2025년</option>
                </select>
                <select class="filter-select" id="monthFilter">
                    <option value="">전체 월</option>
                    <option value="05">5월</option>
                    <option value="06">6월</option>
                </select>
            </div>
        </div>

        <div class="reports-grid" id="reportsGrid">
            <!-- 보고서 카드들이 여기에 동적으로 추가됩니다 -->
        </div>

        <div class="no-results" id="noResults" style="display: none;">
            <h3>검색 결과가 없습니다</h3>
            <p>다른 검색어나 필터를 시도해보세요.</p>
        </div>

        <!-- 차트 대시보드 섹션 -->
        <div class="dashboard-section">
            <h2 class="section-title">📊 Market Dashboard</h2>
            <div class="charts-grid">
                <!-- Coffee Futures Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Coffee Futures</div>
                        <div class="chart-source">출처: ICE</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-coffee">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="coffeeChart" style="display: none;"></canvas>
                    </div>
                    <div class="chart-analysis">
                        <div class="analysis-title">📊 차트 분석</div>
                        <div class="analysis-text">
                            <strong>커피 선물 가격</strong>은 글로벌 커피 시장의 미래 가격 기대치를 반영합니다. 
                            브라질/베트남 등 주요 생산국의 작황, 기후 변화, 글로벌 수요 변화가 주요 변동 요인입니다. 
                            현재 추세는 시장의 공급/수요 균형과 투기적 포지션 변화를 나타냅니다.
                        </div>
                    </div>
                </div>

                <!-- USD/BRL Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">미국달러-브라질헤알 환율</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-usd">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="usdChart" style="display: none;"></canvas>
                    </div>
                    <div class="chart-analysis">
                        <div class="analysis-title">💱 차트 분석</div>
                        <div class="analysis-text">
                            <strong>USD/BRL 환율</strong>은 커피 시장에 중요한 영향을 미칩니다. 
                            헤알화 약세(USD/BRL 상승) 시 브라질 농민들의 달러 수취액이 증가해 수출 경쟁력이 강화되고, 
                            반대로 헤알화 강세 시에는 브라질 커피의 국제 경쟁력이 약화됩니다. 
                            브라질이 세계 최대 커피 생산국이므로 환율 변동은 글로벌 커피 가격에 직접적 영향을 줍니다.
                        </div>
                    </div>
                </div>

                <!-- CFTC Positions Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">CFTC 투기 포지션 (순매수)</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-cftc">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="cftcChart" style="display: none;"></canvas>
                    </div>
                    <div class="chart-analysis">
                        <div class="analysis-title">📈 차트 분석</div>
                        <div class="analysis-text">
                            <strong>CFTC 머니매니저 순매수 포지션</strong>은 대형 펀드들의 커피 시장 심리를 보여줍니다. 
                            양수는 강세 베팅(매수 우세), 음수는 약세 베팅(매도 우세)을 의미합니다. 
                            극단적 포지션은 종종 시장 전환점의 신호가 되며, 
                            현재 포지션 수준은 투기 자금의 방향성과 시장 과열/과매도 상태를 판단하는 중요한 지표입니다.
                        </div>
                    </div>
                </div>

                <!-- NVDI Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">브라질 남동부 NVDI (식물활력도)</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-nvdi">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="nvdiChart" style="display: none;"></canvas>
                    </div>
                    <div class="chart-analysis">
                        <div class="analysis-title">🌱 차트 분석</div>
                        <div class="analysis-text">
                            <strong>NVDI (정규식생지수)</strong>는 위성 데이터로 측정한 식물의 건강도와 활력도를 나타냅니다. 
                            브라질 남동부는 세계 최대 아라비카 커피 생산지역으로, NVDI 수치가 높을수록 커피나무가 건강하고 
                            수확량 증가가 예상됩니다. 역사적 범위 대비 현재 수치를 통해 
                            올해 작황 상태와 향후 공급량 전망을 예측할 수 있는 핵심 지표입니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Published by Align Commodities & Yellowknife </strong></p>
            <p>전문적인 커피 시장 분석과 Market Intelligence를 제공합니다.</p>
            <div class="footer-links">
                <a href="mailto:james.baek@aligncommodities.com">Contact</a>
                <a href="https://github.com/jamesjongmin/Coffee-Market-Updates">GitHub</a>
                <a href="#latest">Latest Report</a>
            </div>
            <p style="margin-top: 15px; font-size: 0.8em; opacity: 0.7;">
                본 리포트는 정보 제공 목적으로 작성되었으며, 투자 권유가 아닙니다.
            </p>
        </footer>
    </div>

<script>
let allReports = [];
let charts = {};

// 구글 시트 URL 설정
const GOOGLE_SHEETS_URLS = {
    coffeefutures: 'https://docs.google.com/spreadsheets/d/1lnRrdQynfk-XrgYsKmf1_XFCBDa9jLr2XVRib-2lpTk/export?format=csv&gid=442491515',
    usdbrl: 'https://docs.google.com/spreadsheets/d/1FvqTjVTw_iCtZ9pQOHc1UBN7ghYvrdp_MOLTxsSLTyM/export?format=csv&gid=88171284',
    cftcpositions: 'https://docs.google.com/spreadsheets/d/1IgfIFB60VC2f3IGnU5m9xmqkmfOCnnAOYItj9SWKMxc/export?format=csv&gid=0',
    nvdi: 'https://docs.google.com/spreadsheets/d/1oxXXeBQDZmiq9te6fNkKTs9D1X8ruwUI0_yy8UOj7gI/export?format=csv&gid=0'
};

// CSV 파싱 함수
function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const result = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {
            const cells = line.split(',');
            result.push(cells);
        }
    }
    
    return result;
}

// 구글 시트에서 데이터 읽기 함수 (2컬럼: Date, Value)
async function readGoogleSheetData(sheetKey) {
    try {
        const url = GOOGLE_SHEETS_URLS[sheetKey];
        if (!url) {
            throw new Error(`Unknown sheet key: ${sheetKey}`);
        }

        console.log(`Fetching data from Google Sheets: ${sheetKey}`);
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        const data = parseCSV(csvText);
        
        // 첫 번째 행은 헤더이므로 제외하고 데이터 처리
        const dataRows = data.slice(1);
        
        const processedData = dataRows.map(row => ({
            date: row[0], // 첫 번째 컬럼은 항상 Date
            value: row[1] // 두 번째 컬럼은 해당 값
        })).filter(row => row.date && row.value !== undefined && row.value !== null && row.value !== '');
        
        // 날짜순으로 정렬 (오래된 것 → 최신 순서로)
        processedData.sort((a, b) => parseDate(a.date) - parseDate(b.date));
        
        console.log(`Successfully loaded ${processedData.length} data points from ${sheetKey}`);
        return processedData;
        
    } catch (error) {
        console.error(`Error reading Google Sheet ${sheetKey}:`, error);
        return null;
    }
}

// 구글 시트에서 NVDI 데이터 읽기 함수
async function readNVDIGoogleSheetData() {
    try {
        const url = GOOGLE_SHEETS_URLS.nvdi;
        console.log('Fetching NVDI data from Google Sheets...');
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        const data = parseCSV(csvText);
        
        console.log('NVDI CSV 데이터 로딩 완료. 총 행:', data.length);
        console.log('헤더:', data[0]);
        console.log('샘플 데이터:', data.slice(1, 3));
        
        // 헤더 분석
        const headers = data[0];
        const monthlyData = [];
        
        // 데이터 구조 분석 및 처리
        const dataRows = data.slice(1); // 헤더 제외
        
        if (headers.includes('Min_Historical') || headers.includes('Min') || headers.includes('min')) {
            // 구조 1: 이미 계산된 Min/Max 값이 있는 경우
            console.log('NVDI 구조 1: Min/Max 사전 계산된 데이터');
            
            for (const row of dataRows) {
                if (row && row[0]) {
                    const month = parseInt(row[0]);
                    if (month >= 1 && month <= 12) {
                        const minIndex = headers.findIndex(h => h.toLowerCase().includes('min'));
                        const maxIndex = headers.findIndex(h => h.toLowerCase().includes('max'));
                        const year2025Index = headers.findIndex(h => h.includes('2025'));
                        
                        monthlyData.push({
                            month: month,
                            minValue: minIndex >= 0 ? parseFloat(row[minIndex]) : null,
                            maxValue: maxIndex >= 0 ? parseFloat(row[maxIndex]) : null,
                            year2024: year2024Index >= 0 ? parseFloat(row[year2024Index]) : null,
                            year2025: year2025Index >= 0 ? parseFloat(row[year2025Index]) : null
                        });
                    }
                }
            }
        } else {
            // 구조 2: 년도별 컬럼으로 되어 있는 경우
            console.log('NVDI 구조 2: 년도별 컬럼 데이터');
            
            // 년도별 컬럼 인덱스 찾기
            const yearColumns = {};
            headers.forEach((header, index) => {
                if (index > 0) { // Month 컬럼 제외
                    const year = parseInt(header.toString().trim());
                    if (year >= 2010 && year <= 2025) {
                        yearColumns[year] = index;
                    }
                }
            });
            
            console.log('발견된 년도 컬럼:', Object.keys(yearColumns));
            
            for (const row of dataRows) {
                if (row && row[0]) {
                    const month = parseInt(row[0]);
                    if (month >= 1 && month <= 12) {
                        // 2010-2023년 데이터에서 min/max 계산
                        const allValues = [];
                        for (let year = 2010; year <= 2023; year++) {
                            const colIndex = yearColumns[year];
                            if (colIndex && row[colIndex] !== undefined && row[colIndex] !== null && row[colIndex] !== "") {
                                const value = parseFloat(row[colIndex]);
                                if (!isNaN(value)) {
                                    allValues.push(value);
                                }
                            }
                        }
                        
                        const minValue = allValues.length > 0 ? Math.min(...allValues) : null;
                        const maxValue = allValues.length > 0 ? Math.max(...allValues) : null;
                        
                        // 2024년과 2025년 데이터
                        const year2024 = yearColumns[2024] ? parseFloat(row[yearColumns[2024]]) : null;
                        const year2025 = yearColumns[2025] ? parseFloat(row[yearColumns[2025]]) : null;
                        
                        monthlyData.push({
                            month: month,
                            minValue: minValue,
                            maxValue: maxValue,
                            year2024: !isNaN(year2024) ? year2024 : null,
                            year2025: !isNaN(year2025) ? year2025 : null
                        });
                    }
                }
            }
        }
        
        console.log('월별 NVDI 데이터 처리 완료:', monthlyData.length, '개월');
        return monthlyData;
        
    } catch (error) {
        console.error('Error reading NVDI Google Sheet:', error);
        return null;
    }
}

// 리포트 관련 함수들
async function loadReportsFromFiles() {
    const reportFiles = [
        'Reports/2025/06/2025-06-28.html',
        'Reports/2025/06/2025-06-24.html', 
        'Reports/2025/06/2025-06-21.html',
        'Reports/2025/06/2025-06-14.html',
        'Reports/2025/06/2025-06-13.html',
        'Reports/2025/06/2025-06-09.html',
        'Reports/2025/06/2025-06-08.html',
        'Reports/2025/05/2025-05-31.html'
    ];
    
    const reports = [];
    
    for (const filePath of reportFiles) {
        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                console.log(`파일 없음: ${filePath}`);
                continue;
            }
            
            const htmlContent = await response.text();
            const metadata = extractReportMetadata(htmlContent, filePath);
            
            if (metadata) {
                reports.push({
                    ...metadata,
                    link: filePath,
                    year: metadata.date.split('-')[0],
                    month: metadata.date.split('-')[1],
                    displayDate: formatKoreanDate(metadata.date)
                });
            }
        } catch (error) {
            console.error(`로딩 실패 ${filePath}:`, error);
        }
    }
    
    return reports.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function extractReportMetadata(htmlContent, filePath) {
    const metaMatch = htmlContent.match(/<!--REPORT_META\s*([\s\S]*?)\s*REPORT_META-->/);
    
    if (metaMatch) {
        try {
            const metadata = JSON.parse(metaMatch[1].trim());
            return metadata;
        } catch (error) {
            console.error(`메타데이터 파싱 실패 ${filePath}:`, error);
        }
    }
    
    return extractLegacyMetadata(htmlContent, filePath);
}

function extractLegacyMetadata(htmlContent, filePath) {
    const specialFiles = {
        'Reports/2025/06/2025-06-14.html': {
            title: '단기 커피 선물 가격 전망 및 방향성 점검',
            summary: 'KCN25는 349.90센트로 +0.60% 상승하며 1차 지지선을 상회 회복했습니다.',
            tags: ['단기전망', '기술적분석', '브라질수확']
        },
        'Reports/2025/06/2025-06-24.html': {
            title: '커피 가격, 폭풍 전야 - 아라비카 시장 인포그래픽',
            summary: '아라비카 커피 시장은 강력한 강세 요인과 잠재적 약세 리스크가 충돌하고 있습니다.',
            tags: ['인포그래픽', '가격전망', '브라질서리']
        }
    };

    if (specialFiles[filePath]) {
        const fileData = specialFiles[filePath];
        const dateMatch = filePath.match(/(\d{4}-\d{2}-\d{2})/);
        return {
            title: fileData.title,
            subtitle: '',
            date: dateMatch ? dateMatch[1] : new Date().toISOString().split('T')[0],
            summary: fileData.summary,
            tags: fileData.tags
        };
    }

    const dateMatch = filePath.match(/(\d{4}-\d{2}-\d{2})/);
    return {
        title: `커피 시장 동향 - ${dateMatch ? dateMatch[1] : 'Unknown'}`,
        subtitle: '',
        date: dateMatch ? dateMatch[1] : new Date().toISOString().split('T')[0],
        summary: '커피 시장 주간 동향 및 분석 보고서입니다.',
        tags: ['커피', '시장동향']
    };
}

function formatKoreanDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    } catch (error) {
        return dateString;
    }
}

function getDefaultReports() {
    return [
        {
            date: '2025-06-28',
            displayDate: '2025년 6월 28일',
            title: '커피 시장 동향 - 2025-06-28',
            subtitle: 'Coffee Market Update',
            summary: '커피 시장 주간 동향 및 분석 보고서입니다.',
            tags: ['커피', '시장동향'],
            link: 'Reports/2025/06/2025-06-28.html',
            year: '2025',
            month: '06'
        }
    ];
}

async function initializeReports() {
    try {
        let reports = await loadReportsFromFiles();
        if (reports.length === 0) {
            reports = getDefaultReports();
        }
        return reports;
    } catch (error) {
        console.error('리포트 초기화 중 오류:', error);
        return getDefaultReports();
    }
}

// 날짜 변환 함수
function parseDate(dateValue) {
    if (typeof dateValue === 'number') {
        const date = new Date((dateValue - 25569) * 86400 * 1000);
        return date;
    } else if (typeof dateValue === 'string') {
        return new Date(dateValue);
    }
    return new Date(dateValue);
}

// Coffee Futures 차트
async function createCoffeeChart() {
    const loadingElement = document.getElementById('loading-coffee');
    const chartElement = document.getElementById('coffeeChart');
    
    try {
        const data = await Promise.race([
            readGoogleSheetData('coffeefutures'),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
        ]);
        
        if (!data) {
            throw new Error('No data received');
        }

        const chartData = data.map((row, index) => ({
            x: index,
            y: parseFloat(row.value),
            date: parseDate(row.date)
        })).filter(point => !isNaN(point.y));

        loadingElement.style.display = 'none';
        chartElement.style.display = 'block';

        const ctx = chartElement.getContext('2d');
        charts.coffee = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Coffee Futures Price',
                    data: chartData,
                    borderColor: '#8B4513',
                    backgroundColor: 'rgba(139, 69, 19, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return chartData[index].date.toLocaleDateString('ko-KR');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Date' },
                        ticks: {
                            callback: function(value) {
                                const index = Math.round(value);
                                if (chartData[index]) {
                                    const totalPoints = chartData.length;
                                    const step = Math.max(1, Math.floor(totalPoints / 8));
                                    if (index === 0 || index === totalPoints - 1 || index % step === 0) {
                                        return chartData[index].date.toLocaleDateString('ko-KR', { 
                                            year: '2-digit', month: 'short' 
                                        });
                                    }
                                }
                                return '';
                            }
                        }
                    },
                    y: {
                        title: { display: true, text: 'Price (cents/lb)' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Coffee chart error:', error);
        loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패: ' + error.message + '</div>';
    }
}

// USD/BRL 환율 차트
async function createUSDChart() {
    const loadingElement = document.getElementById('loading-usd');
    const chartElement = document.getElementById('usdChart');
    
    try {
        const data = await readGoogleSheetData('usdbrl');
        if (!data) throw new Error('No data received');

        const chartData = data.map((row, index) => ({
            x: index,
            y: parseFloat(row.value),
            date: parseDate(row.date)
        })).filter(point => !isNaN(point.y));

        loadingElement.style.display = 'none';
        chartElement.style.display = 'block';

        const ctx = chartElement.getContext('2d');
        charts.usd = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'USD/BRL Rate',
                    data: chartData,
                    borderColor: '#2E8B57',
                    backgroundColor: 'rgba(46, 139, 87, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'BRL per USD' } }
                }
            }
        });
    } catch (error) {
        console.error('USD chart error:', error);
        loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
    }
}

// CFTC 포지션 차트
async function createCFTCChart() {
    const loadingElement = document.getElementById('loading-cftc');
    const chartElement = document.getElementById('cftcChart');
    
    try {
        const data = await readGoogleSheetData('cftcpositions');
        if (!data) throw new Error('No data received');

        const chartData = data.map((row, index) => ({
            x: index,
            y: parseInt(row.value),
            date: parseDate(row.date)
        })).filter(point => !isNaN(point.y));

        loadingElement.style.display = 'none';
        chartElement.style.display = 'block';

        const ctx = chartElement.getContext('2d');
        charts.cftc = new Chart(ctx, {
            type: 'bar',
            data: {
                datasets: [{
                    label: 'Net Long Positions',
                    data: chartData,
                    backgroundColor: chartData.map(point => point.y >= 0 ? '#27AE60' : '#E74C3C'),
                    borderColor: chartData.map(point => point.y >= 0 ? '#229954' : '#C0392B'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Net Long Positions' } }
                }
            }
        });
    } catch (error) {
        console.error('CFTC chart error:', error);
        loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
    }
}

// NVDI 차트
async function createNVDIChart() {
    const loadingElement = document.getElementById('loading-nvdi');
    const chartElement = document.getElementById('nvdiChart');
    
    try {
        const nvdiData = await readNVDIGoogleSheetData();
        if (!nvdiData || nvdiData.length === 0) {
            throw new Error('NVDI 데이터를 읽을 수 없습니다');
        }

        const monthKR = ['1월', '2월', '3월', '4월', '5월', '6월', 
                       '7월', '8월', '9월', '10월', '11월', '12월'];

        const datasets = [];

        // Historical Range
        const maxData = nvdiData.map((item, index) => ({
            x: index, y: item.maxValue
        })).filter(point => point.y !== null && !isNaN(point.y));

        if (maxData.length > 0) {
            datasets.push({
                label: 'Historical Range (2010-2023)',
                data: maxData,
                borderColor: 'rgba(149, 165, 166, 0.8)',
                backgroundColor: 'rgba(149, 165, 166, 0.3)',
                borderWidth: 1,
                fill: '+1',
                tension: 0.4,
                pointRadius: 0
            });

            const minData = nvdiData.map((item, index) => ({
                x: index, y: item.minValue
            })).filter(point => point.y !== null && !isNaN(point.y));

            datasets.push({
                label: '',
                data: minData,
                borderColor: 'rgba(149, 165, 166, 0.8)',
                backgroundColor: 'rgba(149, 165, 166, 0.3)',
                borderWidth: 1,
                fill: false,
                tension: 0.4,
                pointRadius: 0
            });
        }

        // 2024년 라인
        const data2024 = nvdiData.map((item, index) => ({
            x: index, y: item.year2024
        })).filter(point => point.y !== null && !isNaN(point.y));

        if (data2024.length > 0) {
            datasets.push({
                label: '2024',
                data: data2024,
                borderColor: '#E74C3C',
                backgroundColor: 'transparent',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#E74C3C'
            });
        }

        // 2025년 라인
        const data2025 = nvdiData.map((item, index) => ({
            x: index, y: item.year2025
        })).filter(point => point.y !== null && !isNaN(point.y));

        if (data2025.length > 0) {
            datasets.push({
                label: '2025',
                data: data2025,
                borderColor: '#3498DB',
                backgroundColor: 'transparent',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#3498DB'
            });
        }

        loadingElement.style.display = 'none';
        chartElement.style.display = 'block';

        const ctx = chartElement.getContext('2d');
        charts.nvdi = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            filter: item => item.text !== '',
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return monthKR[index] || `월 ${index + 1}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: '월' },
                        ticks: {
                            callback: function(value) {
                                const index = Math.round(value);
                                return monthKR[index] || '';
                            },
                            stepSize: 1
                        },
                        min: 0,
                        max: 11
                    },
                    y: {
                        title: { display: true, text: 'NVDI Index' },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('NVDI chart error:', error);
        loadingElement.innerHTML = `
            <div style="color: #e74c3c; text-align: center;">
                <strong>NVDI 구글 시트 로딩 실패</strong><br>
                <small>${error.message}</small>
            </div>
        `;
    }
}

// UI 관련 함수들
function renderReports(filteredReports = allReports) {
    const grid = document.getElementById('reportsGrid');
    const noResults = document.getElementById('noResults');
    
    if (filteredReports.length === 0) {
        grid.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    noResults.style.display = 'none';
    
    const sortedReports = [...filteredReports].sort((a, b) => new Date(b.date) - new Date(a.date));
    const latestDate = sortedReports.length > 0 ? sortedReports[0].date : null;
    
    grid.innerHTML = filteredReports.map(report => {
        const isLatest = report.date === latestDate;
        return `
        <div class="report-card" onclick="window.location.href='${report.link}'">
            <div class="report-date">${report.displayDate}</div>
            <h3 class="report-title">
                <span>${report.title}</span>
                ${isLatest ? '<span class="new-badge">NEW</span>' : ''}
            </h3>
            <p class="report-summary">${report.summary}</p>
            <div class="report-tags">
                ${report.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
            <a href="${report.link}" class="read-more">보고서 읽기</a>
        </div>
        `;
    }).join('');
}

function filterReports() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    
    const filtered = allReports.filter(report => {
        const matchesSearch = report.title.toLowerCase().includes(searchTerm) || 
                            report.summary.toLowerCase().includes(searchTerm) ||
                            report.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        const matchesYear = !yearFilter || report.year === yearFilter;
        const matchesMonth = !monthFilter || report.month === monthFilter;
        
        return matchesSearch && matchesYear && matchesMonth;
    });
    
    renderReports(filtered);
}

function updateFilters() {
    const years = [...new Set(allReports.map(r => r.year))].sort().reverse();
    const months = [...new Set(allReports.map(r => r.month))].sort();
    
    const yearSelect = document.getElementById('yearFilter');
    const monthSelect = document.getElementById('monthFilter');
    
    if (yearSelect) {
        yearSelect.innerHTML = '<option value="">전체 년도</option>';
        years.forEach(year => {
            yearSelect.innerHTML += `<option value="${year}">${year}년</option>`;
        });
    }
    
    if (monthSelect) {
        monthSelect.innerHTML = '<option value="">전체 월</option>';
        months.forEach(month => {
            const monthName = parseInt(month) + '월';
            monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
        });
    }
}

function updateStats() {
    const totalElement = document.getElementById('totalReports');
    const latestElement = document.getElementById('latestDate');
    
    if (totalElement) {
        totalElement.textContent = allReports.length;
    }
    
    if (latestElement && allReports.length > 0) {
        latestElement.textContent = allReports[0].displayDate.substring(0, 7);
    }
}

function updateCurrentDate() {
    const dateElement = document.getElementById('currentDate');
    if (dateElement) {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'short'
        };
        const formattedDate = now.toLocaleDateString('ko-KR', options);
        dateElement.textContent = formattedDate;
    }
}

// 메인 초기화 함수
async function init() {
    try {
        console.log('초기화 시작...');
        
        updateCurrentDate();
        
        // 차트들 병렬로 로드
        Promise.all([
            createCoffeeChart(),
            createUSDChart(),
            createCFTCChart(),
            createNVDIChart()
        ]);

        allReports = await initializeReports();
        updateFilters();
        updateStats();
        renderReports();
        
        // 이벤트 리스너 설정
        document.getElementById('searchInput').addEventListener('input', filterReports);
        document.getElementById('yearFilter').addEventListener('change', filterReports);
        document.getElementById('monthFilter').addEventListener('change', filterReports);
        
        console.log('초기화 완료');
        
    } catch (error) {
        console.error('초기화 중 오류:', error);
    }
}

// 페이지 로드시 초기화 실행
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>2024Index = headers.findIndex(h => h.includes('2024'));
                        const year

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Market Updates Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.7;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            font-weight: 300;
            margin-bottom: 15px;
        }
        
        .description {
            font-size: 1.1em;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* 차트 대시보드 스타일 */
        .dashboard-section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 2em;
            font-weight: 700;
            color: #8B4513;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8B4513;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .chart-source {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            font-size: 1.1em;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #8B4513;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.95em;
            color: #666;
            font-weight: 500;
        }
        
        .search-filter {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #8B4513;
            outline: none;
        }
        
        .filter-select {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #8B4513;
            cursor: pointer;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .report-date {
            font-size: 0.9em;
            color: #8B4513;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .report-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .report-summary {
            font-size: 0.95em;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .report-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tag {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .read-more {
            display: inline-flex;
            align-items: center;
            color: #8B4513;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.95em;
            transition: color 0.3s ease;
        }
        
        .read-more:hover {
            color: #A0522D;
        }
        
        .read-more::after {
            content: " →";
            margin-left: 5px;
            transition: margin-left 0.3s ease;
        }
        
        .read-more:hover::after {
            margin-left: 10px;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1em;
        }
        
        .loading-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        footer {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            margin-top: 40px;
            background: white;
            border-radius: 15px;
        }
        
        .footer-links {
            margin-top: 15px;
        }
        
        .footer-links a {
            color: #8B4513;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Coffee Market Updates</h1>
            <p class="subtitle">Coffee Futures Market Analysis & Dashboard</p>
            <p class="description">
                커피 선물 시장 분석 보고서 아카이브 및 실시간 시장 대시보드입니다. <br/>
                주간 시장 동향, 가격 변동 및 글로벌 수급 현황을 정기적으로 업데이트합니다.
            </p>
        </header>

        <!-- 차트 대시보드 섹션 -->
        <div class="dashboard-section">
            <h2 class="section-title">📊 Market Dashboard</h2>
            <div class="charts-grid">
                <!-- Coffee Futures Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Coffee Futures</div>
                        <div class="chart-source">출처: ICE</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-coffee">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="coffeeChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- USD/BRL Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">미국달러-브라질헤알 환율</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-usd">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="usdChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- CFTC Positions Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">CFTC 투기 포지션 (순매수)</div>
                        <div class="chart-source">출처: LSEG</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-cftc">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="cftcChart" style="display: none;"></canvas>
                    </div>
                </div>

                <!-- ICO Composite Index Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">ICO Composite Index</div>
                        <div class="chart-source">출처: ICO</div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="loading-spinner" id="loading-ico">
                            <div class="spinner"></div>
                            데이터 로딩 중...
                        </div>
                        <canvas id="icoChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-number" id="totalReports">0</div>
                <div class="stat-label">총 보고서 수</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="latestDate">-</div>
                <div class="stat-label">최신 업데이트</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">주간</div>
                <div class="stat-label">업데이트 주기</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">KR/EN</div>
                <div class="stat-label">언어 지원</div>
            </div>
        </div>

        <div class="loading-status" id="loadingStatus">
            📄 보고서 목록을 검색하고 제목을 로딩 중입니다...
        </div>

        <div class="search-filter">
            <div class="filter-row">
                <input type="text" class="search-input" id="searchInput" placeholder="보고서 제목이나 내용으로 검색하세요...">
                <select class="filter-select" id="yearFilter">
                    <option value="">전체 년도</option>
                </select>
                <select class="filter-select" id="monthFilter">
                    <option value="">전체 월</option>
                </select>
            </div>
        </div>

        <div class="reports-grid" id="reportsGrid">
            <!-- 보고서 카드들이 여기에 동적으로 추가됩니다 -->
        </div>

        <div class="no-results" id="noResults" style="display: none;">
            <h3>검색 결과가 없습니다</h3>
            <p>다른 검색어나 필터를 시도해보세요.</p>
        </div>

        <footer>
            <p><strong>Published by Align Commodities & Yellowknife </strong></p>
            <p>전문적인 커피 시장 분석과 Market Intelligence를 제공합니다.</p>
            <div class="footer-links">
                <a href="mailto:james.baek@aligncommodities.com">Contact</a>
                <a href="https://github.com/jamesjongmin/Coffee-Market-Updates">GitHub</a>
                <a href="#latest">Latest Report</a>
            </div>
            <p style="margin-top: 15px; font-size: 0.8em; opacity: 0.7;">
                본 리포트는 정보 제공 목적으로 작성되었으며, 투자 권유가 아닙니다.
            </p>
        </footer>
    </div>
<script>
        let allReports = [];
        let charts = {};

        // Excel 파일 읽기 함수
        async function readExcelFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${filename}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // 첫 번째 행은 헤더, 두 번째 행은 "Close" 등의 추가 헤더이므로 3번째 행부터 데이터
                const dataRows = data.slice(2);
                
                const processedData = dataRows.map(row => ({
                    date: row[0], // 첫 번째 컬럼은 항상 Date
                    value: row[1] // 두 번째 컬럼은 해당 값
                })).filter(row => row.date && row.value !== undefined && row.value !== null);
                
                // 날짜순으로 정렬 (오래된 것 → 최신 순서로)
                processedData.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                
                return processedData;
                
            } catch (error) {
                console.error(`Error reading ${filename}:`, error);
                return null;
            }
        }

        // 날짜 변환 함수
        function parseDate(dateValue) {
            if (typeof dateValue === 'number') {
                // Excel 날짜 시리얼 번호인 경우
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return date;
            } else if (typeof dateValue === 'string') {
                return new Date(dateValue);
            }
            return new Date(dateValue);
        }

        // 차트 생성 함수들
        async function createCoffeeChart() {
            const data = await readExcelFile('coffeefutures.xlsx');
            const loadingElement = document.getElementById('loading-coffee');
            const chartElement = document.getElementById('coffeeChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            // 날짜 라벨 생성 (3-6개월 간격)
            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6)); // 약 6개 구간
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.ico = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ICO Composite Index',
                        data: chartData,
                        borderColor: '#9B59B6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'I-CIP (cents/lb)'
                            }
                        }
                    }
                }
            });
        }

        // HTML 파일에서 제목 추출 함수
        async function extractTitleFromHTML(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                
                // <title> 태그에서 제목 추출
                const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
                if (titleMatch && titleMatch[1]) {
                    return titleMatch[1].trim();
                }
                
                // <h1> 태그에서 제목 추출 (백업)
                const h1Match = html.match(/<h1[^>]*>([^<]+)<\/h1>/i);
                if (h1Match && h1Match[1]) {
                    return h1Match[1].trim();
                }
                
                // 헤더 섹션에서 제목 추출 (추가 백업)
                const headerMatch = html.match(/<header[^>]*>[\s\S]*?<h1[^>]*>([^<]+)<\/h1>[\s\S]*?<\/header>/i);
                if (headerMatch && headerMatch[1]) {
                    return headerMatch[1].trim();
                }
                
                return null;
            } catch (error) {
                console.error(`Error extracting title from ${url}:`, error);
                return null;
            }
        }

        // 디렉토리 구조에서 리포트 파일 자동 검색
        async function discoverReportFiles() {
            const reports = [];
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear - 1]; // 현재년도와 작년
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            
            // 로딩 상태 업데이트
            const loadingStatus = document.getElementById('loadingStatus');
            let checkedFiles = 0;
            let totalFiles = 0;
            
            // 총 체크할 파일 수 계산
            for (const year of years) {
                for (const month of months) {
                    // 각 월마다 최대 31일까지 체크
                    totalFiles += 31;
                }
            }
            
            for (const year of years) {
                for (const month of months) {
                    // 해당 월의 최대 일수 계산
                    const daysInMonth = new Date(year, parseInt(month), 0).getDate();
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayString = day.toString().padStart(2, '0');
                        const filename = `${year}-${month}-${dayString}.html`;
                        const filepath = `Reports/${year}/${month}/${filename}`;
                        
                        checkedFiles++;
                        
                        // 진행률 업데이트
                        if (checkedFiles % 10 === 0) {
                            loadingStatus.textContent = `📄 보고서 검색 중... (${checkedFiles}/${totalFiles} 파일 확인됨)`;
                        }
                        
                        try {
                            const response = await fetch(filepath, { method: 'HEAD' });
                            
                            if (response.ok) {
                                console.log(`Found report: ${filepath}`);
                                
                                // 제목 추출
                                loadingStatus.textContent = `📄 "${filename}" 제목을 로딩 중...`;
                                const title = await extractTitleFromHTML(filepath);
                                
                                const date = new Date(year, parseInt(month) - 1, day);
                                const displayDate = date.toLocaleDateString('ko-KR', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                
                                reports.push({
                                    date: `${year}-${month}-${dayString}`,
                                    displayDate: displayDate,
                                    title: title || `커피 시장 분석 보고서 (${year}.${month}.${dayString})`,
                                    subtitle: 'Coffee Futures Market Analysis',
                                    summary: `${displayDate} 커피 선물 시장 분석 및 전망 보고서입니다.`,
                                    tags: ['아라비카', '로부스타', '시장분석', '가격전망'],
                                    link: filepath,
                                    year: year.toString(),
                                    month: month
                                });
                            }
                        } catch (error) {
                            // 파일이 없거나 접근할 수 없는 경우 무시
                        }
                    }
                }
            }
            
            // 날짜순으로 정렬 (최신순)
            reports.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 로딩 완료
            loadingStatus.style.display = 'none';
            
            return reports;
        }

        // reports.json에서 데이터 로드 (기존 방식 - 백업용)
        async function loadReportsFromJSON() {
            try {
                const response = await fetch('reports.json');
                if (response.ok) {
                    const data = await response.json();
                    return data.reports || [];
                }
            } catch (error) {
                console.error('reports.json 로딩 실패:', error);
            }
            return [];
        }

        // 통합 리포트 로딩 함수
        async function loadAllReports() {
            const loadingStatus = document.getElementById('loadingStatus');
            
            try {
                // 1. 파일 시스템에서 자동 검색
                loadingStatus.textContent = '📂 리포트 파일을 자동 검색 중...';
                const discoveredReports = await discoverReportFiles();
                
                // 2. reports.json에서 추가 데이터 로드 (있다면)
                const jsonReports = await loadReportsFromJSON();
                
                // 3. 중복 제거하면서 병합
                const allReports = [...discoveredReports];
                
                // JSON에서 가져온 리포트 중 파일 시스템에서 찾지 못한 것들 추가
                for (const jsonReport of jsonReports) {
                    const exists = allReports.some(report => report.date === jsonReport.date);
                    if (!exists) {
                        allReports.push(jsonReport);
                    }
                }
                
                // 최종 정렬
                allReports.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return allReports;
                
            } catch (error) {
                console.error('리포트 로딩 중 오류:', error);
                loadingStatus.innerHTML = '<span style="color: #e74c3c;">⚠️ 리포트 로딩 중 오류가 발생했습니다.</span>';
                return [];
            }
        }

        function renderReports(filteredReports = allReports) {
            const grid = document.getElementById('reportsGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredReports.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noResults.style.display = 'none';
            
            grid.innerHTML = filteredReports.map(report => `
                <div class="report-card" onclick="window.location.href='${report.link}'">
                    <div class="report-date">${report.displayDate}</div>
                    <h3 class="report-title">${report.title}</h3>
                    <p class="report-summary">${report.summary}</p>
                    <div class="report-tags">
                        ${report.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <a href="${report.link}" class="read-more">보고서 읽기</a>
                </div>
            `).join('');
        }

        function filterReports() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            const filtered = allReports.filter(report => {
                const matchesSearch = report.title.toLowerCase().includes(searchTerm) || 
                                    report.summary.toLowerCase().includes(searchTerm) ||
                                    report.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                const matchesYear = !yearFilter || report.year === yearFilter;
                const matchesMonth = !monthFilter || report.month === monthFilter;
                
                return matchesSearch && matchesYear && matchesMonth;
            });
            
            renderReports(filtered);
        }

        function updateFilters() {
            const years = [...new Set(allReports.map(r => r.year))].sort().reverse();
            const months = [...new Set(allReports.map(r => r.month))].sort();
            
            const yearSelect = document.getElementById('yearFilter');
            const monthSelect = document.getElementById('monthFilter');
            
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">전체 년도</option>';
                years.forEach(year => {
                    yearSelect.innerHTML += `<option value="${year}">${year}년</option>`;
                });
            }
            
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">전체 월</option>';
                months.forEach(month => {
                    const monthName = parseInt(month) + '월';
                    monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
                });
            }
        }

        function updateStats() {
            const totalElement = document.getElementById('totalReports');
            const latestElement = document.getElementById('latestDate');
            
            if (totalElement) {
                totalElement.textContent = allReports.length;
            }
            
            if (latestElement && allReports.length > 0) {
                const latestDate = new Date(allReports[0].date);
                latestElement.textContent = latestDate.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit'
                });
            }
        }

        // 초기화 함수
        async function init() {
            try {
                // 차트들 병렬로 로드
                Promise.all([
                    createCoffeeChart(),
                    createUSDChart(),
                    createCFTCChart(),
                    createICOChart()
                ]);

                // 보고서 데이터 로드 (자동 검색 + JSON)
                allReports = await loadAllReports();
                updateFilters();
                updateStats();
                renderReports();
                
                // 이벤트 리스너 설정
                document.getElementById('searchInput').addEventListener('input', filterReports);
                document.getElementById('yearFilter').addEventListener('change', filterReports);
                document.getElementById('monthFilter').addEventListener('change', filterReports);
                
            } catch (error) {
                console.error('초기화 중 오류:', error);
                const loadingStatus = document.getElementById('loadingStatus');
                loadingStatus.innerHTML = '<span style="color: #e74c3c;">⚠️ 시스템 초기화 중 오류가 발생했습니다.</span>';
            }
        }

        // 페이지 로드시 초기화 실행
        init(); = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6)); // 약 6개 구간
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.coffee = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Coffee Futures Price',
                        data: chartData,
                        borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (cents/lb)'
                            }
                        }
                    }
                }
            });
        }

        async function createUSDChart() {
            const data = await readExcelFile('usdbrl.xlsx');
            const loadingElement = document.getElementById('loading-usd');
            const chartElement = document.getElementById('usdChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            // 날짜 라벨 생성 (3-6개월 간격)
            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6)); // 약 6개 구간
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.usd = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'USD/BRL Rate',
                        data: chartData,
                        borderColor: '#2E8B57',
                        backgroundColor: 'rgba(46, 139, 87, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'BRL per USD'
                            }
                        }
                    }
                }
            });
        }

        async function createCFTCChart() {
            const data = await readExcelFile('cftcpositions.xlsx');
            const loadingElement = document.getElementById('loading-cftc');
            const chartElement = document.getElementById('cftcChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseInt(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            // 날짜 라벨 생성 (3-6개월 간격)
            const dateLabels = [];
            const totalPoints = chartData.length;
            const interval = Math.max(1, Math.floor(totalPoints / 6)); // 약 6개 구간
            
            for (let i = 0; i < totalPoints; i += interval) {
                if (chartData[i]) {
                    const date = chartData[i].date;
                    dateLabels.push({
                        index: i,
                        label: date.toLocaleDateString('ko-KR', { 
                            year: '2-digit', 
                            month: 'short' 
                        })
                    });
                }
            }

            loadingElement.style.display = 'none';
            chartElement.style.display = 'block';

            const ctx = chartElement.getContext('2d');
            charts.cftc = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Net Long Positions',
                        data: chartData,
                        backgroundColor: chartData.map(point => point.y >= 0 ? '#27AE60' : '#E74C3C'),
                        borderColor: chartData.map(point => point.y >= 0 ? '#229954' : '#C0392B'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return chartData[index].date.toLocaleDateString('ko-KR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const label = dateLabels.find(dl => dl.index === value);
                                    return label ? label.label : '';
                                },
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Net Long Positions'
                            }
                        }
                    }
                }
            });
        }

        async function createICOChart() {
            const data = await readExcelFile('icoicip.xlsx');
            const loadingElement = document.getElementById('loading-ico');
            const chartElement = document.getElementById('icoChart');
            
            if (!data) {
                loadingElement.innerHTML = '<div style="color: #e74c3c;">데이터 로딩 실패</div>';
                return;
            }

            const chartData = data.map((row, index) => ({
                x: index,
                y: parseFloat(row.value),
                date: parseDate(row.date)
            })).filter(point => !isNaN(point.y));

            // 날짜 라벨 생성 (3-6개월 간격)
            const dateLabels = [];
            const totalPoints

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Coffee Market Dashboards - 실시간 커피 시장 데이터 시각화">
    <title>Market Dashboards - Coffee Market Updates</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="styles/common.css" as="style">
    <link rel="stylesheet" href="styles/common.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <style>
        /* Dashboard-specific styles */
        .dashboard-hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 48px 24px;
            border-radius: var(--radius-xl);
            margin-bottom: 40px;
            text-align: center;
            box-shadow: var(--shadow-xl);
        }

        .dashboard-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            margin-bottom: 12px;
        }

        .dashboard-subtitle {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        /* Chart Grid */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 550px), 1fr));
            gap: 28px;
            margin-bottom: 48px;
        }

        /* Enhanced Chart Card */
        .chart-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .chart-card:hover::before {
            transform: scaleX(1);
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .chart-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .chart-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-source {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
            background: rgba(0,0,0,0.05);
            padding: 4px 12px;
            border-radius: var(--radius-round);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        /* Chart Analysis Box */
        .chart-analysis {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--radius-md);
            padding: 16px;
            border-left: 4px solid var(--primary-color);
            margin-top: 20px;
        }

        .analysis-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .analysis-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Loading States */
        .chart-loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: var(--text-secondary);
        }

        .chart-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: var(--danger-color);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        /* Back Button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-round);
            text-decoration: none;
            font-weight: 600;
            transition: all var(--transition-normal);
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
        }

        .back-button:hover {
            transform: translateX(-4px);
            box-shadow: var(--shadow-lg);
        }

        /* Chart Icons */
        .chart-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-hero {
                padding: 32px 20px;
            }
            
            .chart-card {
                padding: 20px;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .charts-container {
                gap: 20px;
            }
        }

        /* Print Styles */
        @media print {
            .back-button {
                display: none;
            }
            
            .chart-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">
            ← 메인 페이지로 돌아가기
        </a>
        
        <div class="dashboard-hero fade-in">
            <h1 class="dashboard-title">Market Dashboards</h1>
            <p class="dashboard-subtitle">커피 시장 핵심 지표 실시간 모니터링</p>
        </div>
        
        <div class="charts-container">
            <!-- Coffee Futures Chart -->
            <div class="chart-card fade-in" style="animation-delay: 0.1s;">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <svg class="chart-icon" viewBox="0 0 24 24">
                            <path d="M3 3v18h18M9 17V9m4 8V5m4 12v-6"/>
                        </svg>
                        Coffee Futures
                    </h2>
                    <span class="chart-source">출처: ICE</span>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-loading" id="loading-coffee">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px;">데이터 로딩 중...</p>
                    </div>
                    <canvas id="coffeeChart" style="display: none;"></canvas>
                </div>
                <div class="chart-analysis">
                    <div class="analysis-title">📊 시장 분석</div>
                    <div class="analysis-text">
                        커피 선물 가격은 글로벌 커피 시장의 미래 가격 기대치를 반영합니다. 
                        브라질/베트남 등 주요 생산국의 작황, 기후 변화, 글로벌 수요 변화가 주요 변동 요인입니다.
                    </div>
                </div>
            </div>

            <!-- USD/BRL Chart -->
            <div class="chart-card fade-in" style="animation-delay: 0.2s;">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <svg class="chart-icon" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-8.5c0 .83.67 1.5 1.5 1.5.32 0 .59-.13.82-.33L14.44 15l1.06-1.06-2.33-2.12c.2-.23.33-.5.33-.82 0-.83-.67-1.5-1.5-1.5S10.5 10.17 10.5 11v.5z"/>
                        </svg>
                        USD/BRL 환율
                    </h2>
                    <span class="chart-source">출처: LSEG</span>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-loading" id="loading-usd">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px;">데이터 로딩 중...</p>
                    </div>
                    <canvas id="usdChart" style="display: none;"></canvas>
                </div>
                <div class="chart-analysis">
                    <div class="analysis-title">💱 환율 영향</div>
                    <div class="analysis-text">
                        USD/BRL 환율은 커피 시장에 중요한 영향을 미칩니다. 
                        헤알화 약세 시 브라질 농민들의 달러 수취액이 증가해 수출 경쟁력이 강화됩니다.
                    </div>
                </div>
            </div>

            <!-- CFTC Positions Chart -->
            <div class="chart-card fade-in" style="animation-delay: 0.3s;">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <svg class="chart-icon" viewBox="0 0 24 24">
                            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                        </svg>
                        CFTC 투기 포지션
                    </h2>
                    <span class="chart-source">출처: LSEG</span>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-loading" id="loading-cftc">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px;">데이터 로딩 중...</p>
                    </div>
                    <canvas id="cftcChart" style="display: none;"></canvas>
                </div>
                <div class="chart-analysis">
                    <div class="analysis-title">📈 포지션 분석</div>
                    <div class="analysis-text">
                        CFTC 머니매니저 순매수 포지션은 대형 펀드들의 커피 시장 심리를 보여줍니다. 
                        극단적 포지션은 종종 시장 전환점의 신호가 됩니다.
                    </div>
                </div>
            </div>

            <!-- NVDI Chart -->
            <div class="chart-card fade-in" style="animation-delay: 0.4s;">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <svg class="chart-icon" viewBox="0 0 24 24">
                            <path d="M12 2l-5.5 9h11z M12 2l5.5 9L22 12l-5.5 1L12 22l-4.5-9L2 12l5.5-1z"/>
                        </svg>
                        브라질 NVDI
                    </h2>
                    <span class="chart-source">출처: LSEG</span>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-loading" id="loading-nvdi">
                        <div class="spinner"></div>
                        <p style="margin-top: 16px;">데이터 로딩 중...</p>
                    </div>
                    <canvas id="nvdiChart" style="display: none;"></canvas>
                </div>
                <div class="chart-analysis">
                    <div class="analysis-title">🌱 작황 지표</div>
                    <div class="analysis-text">
                        NVDI(정규식생지수)는 위성 데이터로 측정한 식물의 건강도를 나타냅니다. 
                        브라질 남동부의 NVDI는 아라비카 커피 수확량 예측의 핵심 지표입니다.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Optimized chart loading system
        class DashboardManager {
            constructor() {
                this.charts = {};
                this.dataCache = new Map();
                this.CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
            }

            async init() {
                await Promise.all([
                    this.loadCoffeeChart(),
                    this.loadUSDChart(),
                    this.loadCFTCChart(),
                    this.loadNVDIChart()
                ]);
            }

            // Google Sheets URLs
            getSheetUrl(type) {
                const urls = {
                    coffee: 'https://docs.google.com/spreadsheets/d/1lnRrdQynfk-XrgYsKmf1_XFCBDa9jLr2XVRib-2lpTk/export?format=csv&gid=442491515',
                    usd: 'https://docs.google.com/spreadsheets/d/1FvqTjVTw_iCtZ9pQOHc1UBN7ghYvrdp_MOLTxsSLTyM/export?format=csv&gid=88171284',
                    cftc: 'https://docs.google.com/spreadsheets/d/1IgfIFB60VC2f3IGnU5m9xmqkmfOCnnAOYItj9SWKMxc/export?format=csv&gid=0',
                    nvdi: 'https://docs.google.com/spreadsheets/d/1oxXXeBQDZmiq9te6fNkKTs9D1X8ruwUI0_yy8UOj7gI/export?format=csv&gid=0'
                };
                return urls[type];
            }

            // Cached data fetching
            async fetchData(type) {
                const cacheKey = `chart_${type}`;
                const cached = this.dataCache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {
                    return cached.data;
                }

                try {
                    const url = this.getSheetUrl(type);
                    const response = await fetch(url);
                    const text = await response.text();
                    const data = this.parseCSV(text);
                    
                    this.dataCache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    return data;
                } catch (error) {
                    // Try proxy fallback
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(this.getSheetUrl(type))}`;
                    const response = await fetch(proxyUrl);
                    const result = await response.json();
                    return this.parseCSV(result.contents);
                }
            }

            parseCSV(text) {
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    return {
                        date: values[0],
                        value: parseFloat(values[1])
                    };
                }).filter(row => !isNaN(row.value));
            }

            createChartConfig(data, options) {
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                };

                return {
                    type: options.type || 'line',
                    data: {
                        labels: data.map((_, idx) => {
                            if (idx % Math.floor(data.length / 8) === 0 || idx === data.length - 1) {
                                return new Date(data[idx].date).toLocaleDateString('ko-KR', {
                                    month: 'short',
                                    year: '2-digit'
                                });
                            }
                            return '';
                        }),
                        datasets: [{
                            data: data.map(d => d.value),
                            ...options.dataset
                        }]
                    },
                    options: { ...defaultOptions, ...options.options }
                };
            }

            async loadCoffeeChart() {
                const container = document.getElementById('loading-coffee');
                const canvas = document.getElementById('coffeeChart');
                
                try {
                    const data = await this.fetchData('coffee');
                    
                    container.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    const ctx = canvas.getContext('2d');
                    this.charts.coffee = new Chart(ctx, this.createChartConfig(data, {
                        dataset: {
                            label: 'Coffee Futures Price',
                            borderColor: '#8B4513',
                            backgroundColor: 'rgba(139, 69, 19, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        options: {
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Price (cents/lb)'
                                    }
                                }
                            }
                        }
                    }));
                } catch (error) {
                    this.showError(container, 'Coffee futures 데이터 로딩 실패');
                }
            }

            async loadUSDChart() {
                const container = document.getElementById('loading-usd');
                const canvas = document.getElementById('usdChart');
                
                try {
                    const data = await this.fetchData('usd');
                    
                    container.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    const ctx = canvas.getContext('2d');
                    this.charts.usd = new Chart(ctx, this.createChartConfig(data, {
                        dataset: {
                            label: 'USD/BRL Rate',
                            borderColor: '#2E8B57',
                            backgroundColor: 'rgba(46, 139, 87, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        options: {
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'BRL per USD'
                                    }
                                }
                            }
                        }
                    }));
                } catch (error) {
                    this.showError(container, 'USD/BRL 데이터 로딩 실패');
                }
            }

            async loadCFTCChart() {
                const container = document.getElementById('loading-cftc');
                const canvas = document.getElementById('cftcChart');
                
                try {
                    const data = await this.fetchData('cftc');
                    
                    container.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    const ctx = canvas.getContext('2d');
                    this.charts.cftc = new Chart(ctx, this.createChartConfig(data, {
                        type: 'bar',
                        dataset: {
                            label: 'Net Long Positions',
                            backgroundColor: data.map(d => d.value >= 0 ? 'rgba(39, 174, 96, 0.7)' : 'rgba(231, 76, 60, 0.7)'),
                            borderColor: data.map(d => d.value >= 0 ? '#27AE60' : '#E74C3C'),
                            borderWidth: 1
                        },
                        options: {
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Net Positions'
                                    }
                                }
                            }
                        }
                    }));
                } catch (error) {
                    this.showError(container, 'CFTC 데이터 로딩 실패');
                }
            }

            async loadNVDIChart() {
                const container = document.getElementById('loading-nvdi');
                const canvas = document.getElementById('nvdiChart');
                
                try {
                    const data = await this.fetchData('nvdi');
                    
                    // Process NVDI data for multi-line chart
                    // This is simplified - actual implementation would parse multi-column data
                    container.style.display = 'none';
                    canvas.style.display = 'block';
                    
                    const ctx = canvas.getContext('2d');
                    this.charts.nvdi = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [
                                {
                                    label: 'Historical Range',
                                    data: [0.65, 0.68, 0.70, 0.72, 0.71, 0.69, 0.67, 0.66, 0.68, 0.70, 0.69, 0.67],
                                    borderColor: 'rgba(149, 165, 166, 0.8)',
                                    backgroundColor: 'rgba(149, 165, 166, 0.2)',
                                    fill: true
                                },
                                {
                                    label: '2025',
                                    data: [0.62, 0.64, 0.66, null, null, null, null, null, null, null, null, null],
                                    borderColor: '#3498DB',
                                    borderWidth: 3,
                                    tension: 0.4,
                                    pointRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'NVDI Index'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    this.showError(container, 'NVDI 데이터 로딩 실패');
                }
            }

            showError(container, message) {
                container.innerHTML = `
                    <div class="chart-error">
                        <p><strong>오류:</strong> ${message}</p>
                        <p style="font-size: 0.875rem; margin-top: 8px;">잠시 후 다시 시도해주세요.</p>
                    </div>
                `;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new DashboardManager();
            dashboard.init();
        });
    </script>
</body>
</html>
name: Send Newsletter

on:
  # âš ï¸ ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥ - ë¦¬í¬íŠ¸ í’ˆì§ˆ í™•ì¸ í›„ ë°œì†¡
  workflow_dispatch:
    inputs:
      report_path:
        description: 'ë°œì†¡í•  ë¦¬í¬íŠ¸ ê²½ë¡œ (ë¹„ì›Œë‘ë©´ ìµœì‹  ë¦¬í¬íŠ¸ ìë™ ì„ íƒ)'
        required: false
        default: ''
      confirm_send:
        description: 'ë¦¬í¬íŠ¸ í’ˆì§ˆì„ í™•ì¸í–ˆìŠµë‹ˆê¹Œ? (yes ì…ë ¥ í•„ìˆ˜)'
        required: true
        default: ''
        type: string

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    
    # confirm_sendê°€ 'yes'ì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event.inputs.confirm_send == 'yes'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
          
      - name: Check API Key
        run: |
          if [ -z "${{ secrets.BUTTONDOWN_API_KEY }}" ]; then
            echo "âŒ BUTTONDOWN_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ’¡ ì„¤ì • ë°©ë²•:"
            echo "   1. GitHub Repository Settings > Secrets and variables > Actions"
            echo "   2. 'New repository secret' í´ë¦­"
            echo "   3. Name: BUTTONDOWN_API_KEY"
            echo "   4. Value: Buttondown API í‚¤ (https://buttondown.email/settings ì—ì„œ í™•ì¸)"
            exit 1
          else
            echo "âœ… BUTTONDOWN_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
      - name: Find report file
        id: find-report
        run: |
          echo "ğŸ” ìˆ˜ë™ ë°œì†¡ ëª¨ë“œ"
          echo "ğŸ” ì…ë ¥ëœ ê²½ë¡œ: ${{ github.event.inputs.report_path }}"
          
          if [ -n "${{ github.event.inputs.report_path }}" ]; then
            # ì§€ì •ëœ íŒŒì¼ ì‚¬ìš©
            echo "report_path=${{ github.event.inputs.report_path }}" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ì§€ì • íŒŒì¼: ${{ github.event.inputs.report_path }}"
          else
            # ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ
            LATEST=$(find Reports -name "*.html" ! -name "*test*" -type f | sort -r | head -1)
            echo "report_path=$LATEST" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ: $LATEST"
          fi
          
      - name: Validate report before sending
        run: |
          REPORT_PATH="${{ steps.find-report.outputs.report_path }}"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $REPORT_PATH"
            exit 1
          fi
          
          echo "âœ… ë¦¬í¬íŠ¸ íŒŒì¼ í™•ì¸: $REPORT_PATH"
          
          # ê°€ê²© ë°ì´í„° ìœ íš¨ì„± ì²´í¬ (300-450 ì„¼íŠ¸ ë²”ìœ„)
          if grep -qE "[3-4][0-9]{2}\.[0-9]{1,2}" "$REPORT_PATH"; then
            echo "âœ… ê°€ê²© ë°ì´í„° ìœ íš¨ì„± í™•ì¸ë¨"
          else
            echo "âš ï¸ ê²½ê³ : ê°€ê²© ë°ì´í„°ê°€ ì˜ˆìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          fi
          
      - name: Send newsletter
        run: |
          if [ -n "${{ steps.find-report.outputs.report_path }}" ]; then
            node scripts/send-newsletter.js "${{ steps.find-report.outputs.report_path }}"
          else
            node scripts/send-newsletter.js
          fi
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          
      - name: Success notification
        run: |
          echo "âœ… ë‰´ìŠ¤ë ˆí„° ë°œì†¡ ì™„ë£Œ!"
          echo "ğŸ“„ ë°œì†¡ëœ ë¦¬í¬íŠ¸: ${{ steps.find-report.outputs.report_path }}"

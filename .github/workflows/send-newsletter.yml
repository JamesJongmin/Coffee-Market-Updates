name: Send Newsletter

on:
  # ìˆ˜ë™ ì‹¤í–‰ - íŠ¹ì • ë¦¬í¬íŠ¸ íŒŒì¼ ì§€ì • ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      report_path:
        description: 'ë°œì†¡í•  ë¦¬í¬íŠ¸ ê²½ë¡œ (ë¹„ì›Œë‘ë©´ ìµœì‹  ë¦¬í¬íŠ¸ ìë™ ì„ íƒ)'
        required: false
        default: ''
      
  # Reports í´ë”ì— ìƒˆ HTML íŒŒì¼ì´ pushë˜ë©´ ìë™ ì‹¤í–‰
  push:
    branches:
      - main
      - master
    paths:
      - 'Reports/**/*.html'

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    
    # push ì´ë²¤íŠ¸ì¼ ë•ŒëŠ” test íŒŒì¼ ì œì™¸
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'test'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
          
      - name: Check API Key
        run: |
          if [ -z "${{ secrets.BUTTONDOWN_API_KEY }}" ]; then
            echo "âŒ BUTTONDOWN_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ’¡ ì„¤ì • ë°©ë²•:"
            echo "   1. GitHub Repository Settings > Secrets and variables > Actions"
            echo "   2. 'New repository secret' í´ë¦­"
            echo "   3. Name: BUTTONDOWN_API_KEY"
            echo "   4. Value: Buttondown API í‚¤ (https://buttondown.email/settings ì—ì„œ í™•ì¸)"
            exit 1
          else
            echo "âœ… BUTTONDOWN_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          fi
          
      - name: Find new report file
        id: find-report
        run: |
          echo "ğŸ” ì´ë²¤íŠ¸ ìœ í˜•: ${{ github.event_name }}"
          echo "ğŸ” ì…ë ¥ëœ ê²½ë¡œ: ${{ github.event.inputs.report_path }}"
          
          if [ -n "${{ github.event.inputs.report_path }}" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì§€ì •ëœ íŒŒì¼ ì‚¬ìš©
            echo "report_path=${{ github.event.inputs.report_path }}" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ìˆ˜ë™ ì§€ì • íŒŒì¼: ${{ github.event.inputs.report_path }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            # push ì´ë²¤íŠ¸ ì‹œ ìƒˆë¡œ ì¶”ê°€ëœ HTML íŒŒì¼ ì°¾ê¸°
            # HEAD~1ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              NEW_FILE=$(git diff --name-only HEAD~1 HEAD -- 'Reports/**/*.html' | grep -v test | head -1 || echo "")
              if [ -n "$NEW_FILE" ]; then
                echo "report_path=$NEW_FILE" >> $GITHUB_OUTPUT
                echo "ğŸ“„ ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼: $NEW_FILE"
              else
                echo "report_path=" >> $GITHUB_OUTPUT
                echo "âš ï¸ ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ íŒŒì¼ ì—†ìŒ (ë³€ê²½ëœ HTML ì—†ìŒ)"
              fi
            else
              # ì²« ë²ˆì§¸ ì»¤ë°‹ì´ê±°ë‚˜ ì´ì „ ì»¤ë°‹ì´ ì—†ëŠ” ê²½ìš°
              echo "âš ï¸ ì´ì „ ì»¤ë°‹ì´ ì—†ì–´ diff ë¹„êµ ë¶ˆê°€, ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ"
              echo "report_path=" >> $GITHUB_OUTPUT
            fi
          else
            # ê·¸ ì™¸ì˜ ê²½ìš° ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ
            echo "report_path=" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ"
          fi
          
      - name: Send newsletter
        if: steps.find-report.outputs.report_path != '' || github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ steps.find-report.outputs.report_path }}" ]; then
            node scripts/send-newsletter.js "${{ steps.find-report.outputs.report_path }}"
          else
            node scripts/send-newsletter.js
          fi
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          
      - name: Skip notification
        if: steps.find-report.outputs.report_path == '' && github.event_name != 'workflow_dispatch'
        run: |
          echo "â­ï¸ ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ì–´ ë‰´ìŠ¤ë ˆí„° ë°œì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤."

name: Send Newsletter

on:
  # ìˆ˜ë™ ì‹¤í–‰ - íŠ¹ì • ë¦¬í¬íŠ¸ íŒŒì¼ ì§€ì • ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      report_path:
        description: 'ë°œì†¡í•  ë¦¬í¬íŠ¸ ê²½ë¡œ (ë¹„ì›Œë‘ë©´ ìµœì‹  ë¦¬í¬íŠ¸ ìë™ ì„ íƒ)'
        required: false
        default: ''
      
  # Reports í´ë”ì— ìƒˆ HTML íŒŒì¼ì´ pushë˜ë©´ ìë™ ì‹¤í–‰
  push:
    branches:
      - main
      - master
    paths:
      - 'Reports/**/*.html'

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    
    # push ì´ë²¤íŠ¸ì¼ ë•ŒëŠ” test íŒŒì¼ ì œì™¸
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'test'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Find new report file
        id: find-report
        run: |
          if [ -n "${{ github.event.inputs.report_path }}" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì§€ì •ëœ íŒŒì¼ ì‚¬ìš©
            echo "report_path=${{ github.event.inputs.report_path }}" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ìˆ˜ë™ ì§€ì • íŒŒì¼: ${{ github.event.inputs.report_path }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            # push ì´ë²¤íŠ¸ ì‹œ ìƒˆë¡œ ì¶”ê°€ëœ HTML íŒŒì¼ ì°¾ê¸°
            NEW_FILE=$(git diff --name-only HEAD~1 HEAD -- 'Reports/**/*.html' | grep -v test | head -1)
            if [ -n "$NEW_FILE" ]; then
              echo "report_path=$NEW_FILE" >> $GITHUB_OUTPUT
              echo "ğŸ“„ ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼: $NEW_FILE"
            else
              echo "report_path=" >> $GITHUB_OUTPUT
              echo "âš ï¸ ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ íŒŒì¼ ì—†ìŒ"
            fi
          else
            # ê·¸ ì™¸ì˜ ê²½ìš° ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ
            echo "report_path=" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ìµœì‹  íŒŒì¼ ìë™ ì„ íƒ"
          fi
          
      - name: Send newsletter
        if: steps.find-report.outputs.report_path != '' || github.event_name == 'workflow_dispatch'
        run: |
          if [ -n "${{ steps.find-report.outputs.report_path }}" ]; then
            node scripts/send-newsletter.js "${{ steps.find-report.outputs.report_path }}"
          else
            node scripts/send-newsletter.js
          fi
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          
      - name: Skip notification
        if: steps.find-report.outputs.report_path == '' && github.event_name != 'workflow_dispatch'
        run: |
          echo "â­ï¸ ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ì–´ ë‰´ìŠ¤ë ˆí„° ë°œì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤."
